
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>
<SCRIPT language="JavaScript" type="text/javascript" src="http://map.vworld.kr/js/vworldMapInit.js.do?apiKey=8E811AB8-762C-3D4C-80EB-468279376EB7"></SCRIPT>
<script type="text/javascript" src="http://map.vworld.kr/js/map/OpenLayers-2.13/OpenLayers.js" async="false"></script>
<script type="text/javascript" src="/property/resources/js/jquery/jquery.js"></script>
<script type="text/javascript">
var popupContentHTML = "";
popupContentHTML += "<div id='areaInfoWrap'>";
popupContentHTML += "<div id='areaTitle'>";
popupContentHTML += "<img src='/images/list_search.png' class='listIcon' />한라산";
popupContentHTML += "</div>";
popupContentHTML += "<div id='areaInfo'>";
popupContentHTML += "<span><p>위치</p>동경 126°32′ 31″, 북위 33°21′ 31″</span>";
popupContentHTML += "<strong><p>소재지</p>서귀포 토평동 산 15번지</strong>";
popupContentHTML += "<strong><p>분화구면적</p>210,230㎡</strong>";
popupContentHTML += "<strong><p>담수면적</p>11,460㎡</strong>";
popupContentHTML += "<strong><p><a herf=# onclick=hpLink('http://www.hallasan.go.kr/')>한라산홈페이지</a></p></strong>";
popupContentHTML += "</div>";
popupContentHTML += "</div>";


	var ieReturn = 1;
	
	var _ua = navigator.userAgent;
	var rv = -1;
	var ieReturn = 0;	         
	//IE 11,10,9,8
	var trident = _ua.match(/Trident\/(\d.\d)/i);
	if( trident != null )
	{
		if( trident[1] == "7.0" ) ieReturn = 1;
		if( trident[1] == "6.0" ) ieReturn = 1;
		if( trident[1] == "5.0" ) ieReturn = 1;
		if( trident[1] == "4.0" ) ieReturn = 1;
	}
	//IE 7...
	if( navigator.appName == 'Microsoft Internet Explorer' ) ieReturn = 1;

	var apiMap;
	var specXmlDoc;
	var prop_name, prop_val, prop_opr;
	var points = [];
	var output = "json";
	var geometry = "";
	var geoType;
	var buffer = 0;
	var pointControl;
	var sketchColor = '#0649FB';
	var sketchSymbolizers = {
			'Point': {pointRadius: 3,graphicName: 'square',fillColor: 'white',fillOpacity: 1,strokeWidth: 1,strokeOpacity: 1,strokeColor:sketchColor},
			'Line': {strokeWidth: 3,strokeOpacity: 0.6,strokeColor: sketchColor,strokeDashstyle: 'solid'},
			'Polygon': {strokeWidth: 3,strokeOpacity: 0.6,strokeColor: sketchColor,fillColor: sketchColor,fillOpacity: 0.1}
	};
	//var searchFeature = {strokeWidth: 1,		strokeOpacity: 1,	strokeColor: "#2b552b",	fillColor: "#60ca60",	fillOpacity: 0.3}; //녹색
	var searchFeature	= {strokeWidth: 2.5,	strokeOpacity: 0.8,	strokeColor: "#ea6721",	fillColor: "#fff",		fillOpacity: 0.3};
	//var selFeature	= {strokeWidth: 4,		strokeOpacity: 0.8,	strokeColor: "#ea6732",	fillColor: "#ffd2a5",	fillOpacity: 0.3};
	var selFeature		= {strokeWidth: 4,		strokeOpacity: 1,	strokeColor: "#20c02f",	fillColor: "#fff",		fillOpacity: 0.6};
	
	var infoPixel;
	var pageInfo = {
		totalRecord : 	0,
		totalPage	:	0,
		pageIndex	:	1,
		nextPage	:	0,
		prePage		:	0,
		pageUnit	:	10,
		pageSize	:	5
	};

	var dataApiKey = "8E811AB8-762C-3D4C-80EB-468279376EB7";
	//var dataApiKey = "082722A1-6D7E-369C-9F6C-239E589ECA2F";
	var reqUrl	= "http://"+location.host+"/2ddata/";

	
	var map = null;  
	vworld.showMode = false; 
	vworld.init(
		"cont1"	// rootDiv
		, "map-first" // mapType(map=배경지도, raster=항공사진, earth=3D지도),
		,function() {         
			map = this.vmap;  //기본맵 설정  
			map.setBaseLayer(map.vworldBaseMap); 
			map.setControlsType({"simpleMap":true});	//간단한 화면
			var epsg900913 = new OpenLayers.Projection('EPSG:900913');//브이월드 2d지도 좌표
			var epsg4326 = new OpenLayers.Projection('EPSG:4326');//경위도 좌표(ex:127.1100461389, 37.56539025)
			//경위도좌표를 epsg900913좌표변환
			var transCod = new OpenLayers.Geometry.Point('127.072390', '37.591619').transform(epsg4326,epsg900913);
			map.setCenterAndZoom(transCod.x, transCod.y, 17);
			addMarker(transCod.x, transCod.y, popupContentHTML);
			var filterText = "BBOX(14145653.751718,4521913.1875209,14145656.140375,4521915.576178)";
			
		    fnRequestWFS(filterText, jsRSTreatResponse);
			

		}
		,function (obj){SOPPlugin = obj; }//initCallback
		,function (msg){alert('oh my god');}//failCallback
	);
		function setModeCallback(){  //2D/3D 전환후에 실행할 콜백함수 지정
		vworld.setModeCallback(modecallback);  // setmode(?) -  괄호() 안에 0: 2D 배경지도(mode0), 1: 2D 항공사진(mode1), 2: 3D 지도(mode2)
		
	}
		
	//클릭으로 검색
	function pointSearch(){	
		
				var pointOptions = {persist:true}
				if (pointControl == null) {
					pointControl = new OpenLayers.Control.Measure(OpenLayers.Handler.Point,{handlerOptions:pointOptions});
			    	pointControl.events.on({
			    		"measure": function(event){
			    			initMap(); //맵 초기화
			    			/*
			    			// 버퍼입력 시 포인트만 커지고 라인,영역은 안커져서 일단 포인트가 커지는거 삭제
			    			buffer = document.getElementById("buffer").value;
							if(buffer != ""){
								var temp = event.geometry;
								
								poly = new vworld.RegularPolygon({x:temp.x, y:temp.y}, buffer, 36, 0, sketchSymbolizers['Polygon']);
								map.vectorLayer.addFeatures([poly]);
							}
							*/
			    			mapclick(event); // 클릭 이벤트
			    		}
			    	});
			    	map.addControl(pointControl);
				}
				map.init();
			    pointControl.activate();
		}
	
	//맵 초기화		
	function initMap()
	{
		map.init();
		vworldUtil._initInfos();
		map.vectorLayer.removeAllFeatures();
		jsMapsClearMarkers();
		
		geometry	= "";

		$("#divPoi").removeClass("hidden");
		$("#featureList").addClass("hidden");
		
		
		prop_name = prop_val = prop_opr = "";
		
		$(".spm_s_point").parent().removeClass("on");
		$(".spm_s_line").parent().removeClass("on");
		$(".spm_s_polygon").parent().removeClass("on");
	}
	
	//마커 삭제
	function jsMapsClearMarkers(){
		map.clearMarkers(); 
	}
	
	//맵 클릭
	function mapclick(event){
		var temp = event.geometry;
		var pos = new OpenLayers.LonLat(temp.x, temp.y);
		
		addMarker(pos.lon, pos.lat,"",null);
		
		var infoPixelX = 100;
	    var infoPixelY = 100; 
	    
	    //프록시설정
	    OpenLayers.ProxyHost = "./mapProxy.jsp?url=";
	    
	    infoPixel = map.getPixelFromLonLat(pos);
		var pixelX = infoPixel.x;
		var pixelY = infoPixel.y;
	
		var pixel = new OpenLayers.Pixel(pixelX-2,pixelY+2);
		var min = thisMap.getLonLatFromPixel(pixel);
		var pixel = new OpenLayers.Pixel(pixelX+2,pixelY-2);
		var max = thisMap.getLonLatFromPixel(pixel);
	
		var MinX = Math.abs(min.lon);
		var MinY = Math.abs(min.lat);
		var MaxX = Math.abs(max.lon);
		var MaxY = Math.abs(max.lat);
		
		var SearchPoint = MinX + "," + MinY + "," + MaxX + "," + MaxY;		
	
		var filterText = "BBOX(" + SearchPoint + ")";
		
	    fnRequestWFS(filterText, jsRSTreatResponse);		
	}
	
		
	//좌표받아 마커찍기
	function addMarker(lon, lat, message, imgurl){
		var marker = new vworld.Marker(lon, lat,message,"");
		
		// 마커 아이콘 이미지 파일명 설정합니다.
		if (typeof imgurl == 'string') {marker.setIconImage(imgurl);}
		
		// 마커의 z-Index 설정
		marker.setZindex(3);
		
		map.addMarker(marker);
	}

	//API 데이터 조회
	function fnRequestWFS(filterText, success, failure){
	
		geometry = filterText;
		
		try {
			var successCall = null;
			var failureCall = null;
			
			if (typeof success == 'function'){successCall = success; }
			if (typeof failure == 'function'){failureCall = failure; }
	
			OpenLayers.ProxyHost = "./mapProxy.jsp?url=";
			//파라미터 설정
			var buffer	= "";
			
			//속성검색
			var prop_name	= "pnu";
			var prop_val	= "";
			var prop_opr	= "";
			
	    	var params = "";
			params += "apiKey=" + dataApiKey;
			params += "&domain=http://localhost:8080/property";
	    	if(geometry != ""){
	    		params += "&geometry=" + geometry;
	    	}else if(vCurNaviCode != ""){
	    		params += "&emdCd=" + vCurNaviCode;
	    	}
			if(prop_val != ""){
				params += "&filter=" + prop_name + ":"+prop_opr+":" + encodeURI(prop_val);
			}
			//if(prop_val != ""){
			//	params += "&"+prop_name+"=" + encodeURI(prop_val) + "&operator="+prop_opr;
			//}
			params += "&output=" + output;
			params += "&srsName=EPSG:900913";
			
			if(buffer > 0){
				params += "&buffer="+buffer; //범위검색
			}
			if(pageInfo.pageIndex > 1){
				params += "&pageIndex="+pageInfo.pageIndex; //페이지번호
			}
			params += "&pageUnit="+pageInfo.pageUnit; //한페이지당 레코드 수
			//params += "&propertyname=ag_geom,uname,sido_name,sigungu_name"; //특정필드 검색
	
			serviceId = $("#service").val();
			var reqConfig = OpenLayers.Util.extend({
	        		url: "http://apis.vworld.kr/2ddata/cadastral/data?" + params,
	        		headers: {"Content-Type": "text/plain"},
	        		success: successCall,
	        		failure: failureCall,
	        		scope: this
	    		}, {method: "GET"});
		    OpenLayers.Request.issue(reqConfig);
		} catch(e){
			alert("공간정보조회를 실패하였습니다.\n\n" + e.message);
		}
	}
	
	function jsRSTreatResponse(response){
		var features;
		var xmlDoc;
			if(output == "json"){
			var json_str = response.responseText;
			var geojson = eval("(" + json_str + ")");
			
			var code = geojson.header['resultCode'];
			if(code != '200'){
				alert(geojson.header['resultMsg']);
				return;
			}
			
			var geojson_format = new OpenLayers.Format.GeoJSON();
			features = geojson_format.read(geojson.featureCollection);
			
			if(features.length < 1){
				alert("검색된 데이터가 없습니다.");
				return;	
			}
			
			//페이지 정보
			pageInfo.pageIndex = geojson.paginationInfo['pageIndex'];
			pageInfo.totalPage = geojson.paginationInfo['totalPageCount'];
			if(pageInfo.pageIndex < pageInfo.totalPage){
				pageInfo.nextPage = parseInt(pageInfo.pageIndex) + 1;
			}else{
				pageInfo.nextPage = 0;
			}
			if(1 < pageInfo.pageIndex  && 1 < pageInfo.totalPage){
				pageInfo.prePage = parseInt(pageInfo.pageIndex) - 1;
			}else{
				pageInfo.prePage = 0;
			}
			//-- 페이지 정보
			
		}
		       
		var bounds;
		var hideinfo= true;
		
		features.sort(function(a,b){
			var aval = a.fid.split('.')[0];
			var bval = b.fid.split('.')[0];
			return aval < bval ? -1: aval==bval? 0:1;								
		});
		
		vworldInfo.group = [];
		
		var initGroup = false;
		var curAlias = "";
		var curFeats = [];
		var curGroup = "";					    	
		var tabCount =0;
		for(var i=0;i< features.length;i++) {
			
			initGroup = false;								
			var tmpgroup = features[i].fid.split('.')[0];
			if (curGroup == "" || curGroup != tmpgroup) {
				if (curGroup != "") {
					//피쳐그룹 추가
					vworldInfo.group.push({"alias":curAlias,"layer":curGroup,"features":curFeats});
					tabCount ++;
				} 
				initGroup = true;
				curFeats = [];
				curAlias = "";
				curGroup = tmpgroup;
			}  
			//모든 건수를 목록으로..
			if (initGroup){
				if (curAlias == '') {curAlias = curGroup;}							
			} 
			curFeats.push(features[i]);
			if (i == features.length -1) {
				//피쳐그룹 추가
				vworldInfo.group.push({"alias":curAlias,"layer":curGroup,"features":curFeats});
				tabCount ++;
			}								            								
		}
		
		if($("#service").val() != "ademd" && features[0].fid.split('.')[0] == "LT_C_ADEMD_INFO"){
			jsDongShowResponse(0,0);
			fnRequestWFS("", jsRSTreatResponse);
		}else{
			//jsRSTreatShowResponse(0,0);
			jsRSTreatShowResponseList();
		}
		
		features= null;
	}

	//geometry 검색 후 목록 생성
	function jsRSTreatShowResponseList(){
		var groupid	= 0;
		var content = "";
		
		if(pageInfo.totalRecord == 1){
			// 팝업 생성
			vworldInfo.objects2d.push(vworldInfo.group[0].features[0].id);
			drawFeature(0, 0);
			return;
		}
	
		
		map.vectorLayer.addFeatures(vworldInfo.group[groupid].features);
		
		for(var idx=0; idx<vworldInfo.group[groupid].features.length; idx++){
			var feature = vworldInfo.group[groupid].features[idx];
			var gid = feature.fid.split(".")[1];
						
			feature.style = searchFeature;
			vworldInfo.objects2d.push(feature.id);
			
			var x = idx + 1;
		}
	
	
		$("#divPoi").addClass("hidden");
		$("#featureList").removeClass("hidden");
		// document.getElementById("featureList").innerHTML = content;
	}
	
	var preFeatId = "";
	function drawFeature(groupid, idx, fid){
		alert("aaaa");
		alert(groupid);
		alert(idx);
		alert(fid);
		// 목록 배경색 변경
// 		$(".lst_site > li").removeClass("on");
// 		var selectedli = $("#"+fid);
// 		selectedli.addClass("on");
		
// 		// 이전에 선택한 피처 원래 style로 변경
// 		var selectedFeat = vmap.vectorLayer.getFeatureById(preFeatId);
// 		if (selectedFeat){
// 			selectedFeat.style = searchFeature;
// 			map.vectorLayer.addFeatures([selectedFeat]);
// 		}
		
		// 현재 선택한 피처 style 변경
		var feature = vworldInfo.group[groupid].features[idx];
		feature.style = selFeature;
		map.vectorLayer.addFeatures([feature]);
	
		
// 		// 화면 이동 및 팝업 위치 설정
// 		var center = feature.geometry.getCentroid();
// 		if(fid != null && fid != "undefinded" && fid != ""){
// 			map.setCenterAndZoom(center.x, center.y , map.getZoomLevel , "EPSG:900913");
// 		}			
// 		var pos = new OpenLayers.LonLat(center.x, center.y);
// 	    infoPixel = map.getPixelFromLonLat(pos);
	    
// 	    // 팝업 생성
// 		// jsRSTreatShowResponse(groupid, idx);
		
// 		preFeatId = feature.id;
	}
	
	function addMarker(lon, lat, message, imgurl){
	    var marker = new vworld.Marker(lon, lat,message,"");
	     
	    // 마커 아이콘 이미지 파일명 설정합니다.
	    if (typeof imgurl == 'string') {marker.setIconImage(imgurl);}
	     
	    // 마커의 z-Index 설정
	    marker.setZindex(3);
	     
	    map.addMarker(marker);
	    tempMarker = marker; 
	}

</script>
</head>
<body>
<div id="cont1" style="width:900px;height:600px;"></div>

<a class="spm2 spm_s_point" href="javascript:pointSearch();">위치검색</a> 
</body>
</html>